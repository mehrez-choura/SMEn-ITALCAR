<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Facturation STEG - MT</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        window.process = { env: { NODE_ENV: 'production' } };
    </script>

    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://unpkg.com/lucide-react@0.294.0/dist/umd/lucide-react.min.js"></script>

    <style>
        @keyframes bounce-short {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .animate-bounce-short {
            animation: bounce-short 0.5s ease-in-out;
        }
        /* Style pour l'écran de chargement/erreur */
        #debug-console {
            display: none;
            padding: 20px;
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #b91c1c;
            margin: 20px;
            border-radius: 8px;
            font-family: monospace;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="debug-console"></div>

    <div id="root">
        <div class="flex items-center justify-center h-screen text-slate-500">
            Chargement de l'application...<br>
            (Si ce message reste affiché, vérifiez votre connexion internet pour charger les scripts)
        </div>
    </div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const consoleDiv = document.getElementById('debug-console');
            consoleDiv.style.display = 'block';
            consoleDiv.innerHTML = `<strong>Erreur détectée :</strong><br>${message}<br><br>Source: ${source}:${lineno}`;
        };
    </script>

    <script type="text/babel">
        // Vérification que les librairies sont chargées
        if (!window.React || !window.ReactDOM || !window.lucideReact) {
            throw new Error("Les librairies React ou Lucide n'ont pas pu être chargées. Vérifiez votre connexion.");
        }

        const { useState, useEffect } = React;
        
        // Extraction sécurisée des icônes
        const { 
            Zap, Activity, Save, History, TrendingUp, AlertTriangle, Factory, 
            CheckCircle2, BarChart3, Settings, Lock, Unlock, Calendar, DollarSign, 
            TrendingDown, HelpCircle, FileText, Calculator, AlertCircle, Eye, 
            Hash, BookOpen 
        } = window.lucideReact;

        const App = () => {
            // --- État de l'application ---
            const [currentSite, setCurrentSite] = useState(1);
            const [logs, setLogs] = useState([]);
            const [showHelp, setShowHelp] = useState(false);
            const [showUserGuide, setShowUserGuide] = useState(false);
            
            // Configuration Globale (Prix & Taxes)
            const [globalConfig, setGlobalConfig] = useState({
                unitPriceKwh: 0.291,    // Prix Energie Active (DT/kWh)
                powerUnitPrice: 5.000,  // Prix Unitaire Puissance (DT/kVA)
                vatRate: 19,            // TVA (%)
                rtt: 3.500,             // RTT (DT)
                municipalTaxRate: 0.010 // Surtaxte municipale (DT/kWh)
            });

            // Configuration Spécifique par Site (Valeurs par défaut)
            const [siteConfigs, setSiteConfigs] = useState({
                1: { subscribedPower: 250, emptyLosses: 1300 }, // Mégrine
                2: { subscribedPower: 70, emptyLosses: 670 },   // El Khadhra
                3: { subscribedPower: 30, emptyLosses: 160 }    // Naassen
            });

            const [isConfigUnlocked, setIsConfigUnlocked] = useState(false);

            // Date actuelle
            const getCurrentMonth = () => {
                const now = new Date();
                return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            };

            // Données de formulaire
            const [formData, setFormData] = useState({
                1: { lastIndex: 14500, newIndex: '', cosPhi: '', reactiveCons: '', maxPower: '', date: getCurrentMonth(), manualLastIndex: false, lateFees: '', relanceFees: '', adjustment: '' },
                2: { lastIndex: 28900, newIndex: '', cosPhi: '', reactiveCons: '', maxPower: '', date: getCurrentMonth(), manualLastIndex: false, lateFees: '', relanceFees: '', adjustment: '' },
                3: { lastIndex: 56200, newIndex: '', cosPhi: '', reactiveCons: '', maxPower: '', date: getCurrentMonth(), manualLastIndex: false, lateFees: '', relanceFees: '', adjustment: '' },
            });

            const [notification, setNotification] = useState(null);

            // --- Constantes Sites ---
            const SITES = [
                { id: 1, name: "MT 1 - Mégrine", code: "MEG-001" },
                { id: 2, name: "MT 2 - El Khadhra", code: "ELK-002" },
                { id: 3, name: "MT 3 - Naassen", code: "NAS-003" }
            ];

            // --- Helpers Logic ---

            const formatInputDisplay = (val) => {
                if (val === '' || val === undefined || val === null) return '';
                const cleanVal = val.toString().replace(/[^0-9.]/g, ''); 
                return cleanVal.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
            };

            const parseInputValue = (val) => {
                return val.replace(/\s/g, ''); 
            };

            useEffect(() => {
                const siteLogs = logs.filter(l => l.siteId === currentSite).sort((a, b) => b.id - a.id);
                
                if (siteLogs.length > 0) {
                const lastLog = siteLogs[0]; 
                setFormData(prev => ({
                    ...prev,
                    [currentSite]: {
                    ...prev[currentSite],
                    lastIndex: lastLog.newIndex, 
                    manualLastIndex: false
                    }
                }));
                }
            }, [currentSite, logs]);

            const handleInputChange = (field, value) => {
                const cleanValue = (field === 'lastIndex' || field === 'newIndex') ? parseInputValue(value) : value;

                setFormData(prev => {
                const isManualOverride = field === 'lastIndex';
                return {
                    ...prev,
                    [currentSite]: {
                    ...prev[currentSite],
                    [field]: cleanValue,
                    manualLastIndex: isManualOverride ? true : prev[currentSite].manualLastIndex
                    }
                };
                });
            };

            const handleGlobalConfigChange = (field, value) => {
                setGlobalConfig(prev => ({ ...prev, [field]: value }));
            };

            const handleSiteConfigChange = (field, value) => {
                setSiteConfigs(prev => ({
                ...prev,
                [currentSite]: { ...prev[currentSite], [field]: value }
                }));
            };

            // --- COEUR DU CALCUL ---
            const calculateMetrics = () => {
                const data = formData[currentSite];
                const sConf = siteConfigs[currentSite];
                const gConf = globalConfig;

                const newIdx = parseFloat(data.newIndex) || 0;
                const oldIdx = parseFloat(data.lastIndex) || 0;
                const cosPhi = parseFloat(data.cosPhi) || 1; 
                const maxPower = parseFloat(data.maxPower) || 0;
                
                const lateFees = parseFloat(data.lateFees) || 0;
                const relanceFees = parseFloat(data.relanceFees) || 0;
                const adjustment = parseFloat(data.adjustment) || 0;

                const unitPrice = parseFloat(gConf.unitPriceKwh) || 0;
                const subPower = parseFloat(sConf.subscribedPower) || 0;
                const powerPrice = parseFloat(gConf.powerUnitPrice) || 0;
                const vat = (parseFloat(gConf.vatRate) || 0) / 100;
                const rtt = parseFloat(gConf.rtt) || 0;
                const muniTaxRate = parseFloat(gConf.municipalTaxRate) || 0;
                const emptyLosses = parseFloat(sConf.emptyLosses) || 0;

                const energyRecorded = Math.max(0, newIdx - oldIdx);

                const loadLosses = energyRecorded * 0.02; 
                const billedKwh = energyRecorded + emptyLosses + loadLosses;

                const baseEnergyAmountHT = billedKwh * unitPrice;

                let adjustmentRate = 0;
                let adjustmentType = 'none'; 

                if (cosPhi >= 0.91 && cosPhi <= 1) {
                    const steps = Math.round((cosPhi - 0.90) * 100); 
                    adjustmentRate = -(steps * 0.005);
                    adjustmentType = 'bonus';
                } else if (cosPhi >= 0.80 && cosPhi <= 0.90) {
                    adjustmentRate = 0;
                    adjustmentType = 'neutral';
                } else {
                    adjustmentType = 'penalty';
                    let penalty = 0;
                    
                    if (cosPhi < 0.80) {
                        const limit = Math.max(cosPhi, 0.75);
                        const steps = Math.round((0.80 - limit) * 100); 
                        penalty += steps * 0.005;
                    }
                    if (cosPhi < 0.75) {
                        const limit = Math.max(cosPhi, 0.70);
                        const steps = Math.round((0.75 - limit) * 100);
                        penalty += steps * 0.01;
                    }
                    if (cosPhi < 0.70) {
                        const limit = Math.max(cosPhi, 0.60);
                        const steps = Math.round((0.70 - limit) * 100);
                        penalty += steps * 0.015;
                    }
                    if (cosPhi < 0.60) {
                        const steps = Math.round((0.60 - cosPhi) * 100);
                        penalty += steps * 0.02;
                    }
                    adjustmentRate = penalty;
                }

                const cosPhiAdjustmentAmount = baseEnergyAmountHT * adjustmentRate;

                const total1_HT = baseEnergyAmountHT + cosPhiAdjustmentAmount;
                const total1_TTC = total1_HT * (1 + vat);

                const powerPremium = subPower * powerPrice;
                const total2_HT = powerPremium + lateFees + relanceFees;
                const total2_TTC = total2_HT * (1 + vat);

                const municipalTax = billedKwh * muniTaxRate;

                const netToPay = total1_TTC + total2_TTC + rtt + municipalTax + adjustment;

                const isPowerOverrun = maxPower > subPower;

                return {
                energyRecorded,
                loadLosses,
                billedKwh,
                baseEnergyAmountHT,
                adjustmentRate,
                adjustmentType,
                cosPhiAdjustmentAmount,
                total1_HT,
                total1_TTC,
                powerPremium,
                total2_HT,
                total2_TTC,
                municipalTax,
                netToPay,
                isPowerOverrun,
                subscribedPowerRef: subPower
                };
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const metrics = calculateMetrics();
                const currentData = formData[currentSite];

                if (!currentData.newIndex || !currentData.cosPhi || !currentData.maxPower) {
                showNotification("Veuillez remplir les champs obligatoires (*)", "error");
                return;
                }

                const newLog = {
                id: Date.now(),
                recordDate: currentData.date,
                timestamp: new Date().toLocaleTimeString('fr-FR'),
                siteId: currentSite,
                siteName: SITES.find(s => s.id === currentSite).name,
                lastIndex: currentData.lastIndex,
                newIndex: currentData.newIndex,
                cosPhi: currentData.cosPhi,
                maxPower: currentData.maxPower,
                lateFees: currentData.lateFees,
                relanceFees: currentData.relanceFees,
                adjustment: currentData.adjustment,
                ...metrics 
                };

                setLogs([newLog, ...logs]);
                
                setFormData(prev => ({
                ...prev,
                [currentSite]: {
                    ...prev[currentSite],
                    lastIndex: currentData.newIndex, 
                    newIndex: '',
                    cosPhi: '', 
                    reactiveCons: '',
                    maxPower: '',
                    lateFees: '',
                    relanceFees: '',
                    adjustment: '',
                    manualLastIndex: false
                }
                }));
                
                showNotification("Relevé validé et archivé.", "success");
            };

            const showNotification = (msg, type) => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 4000);
            };

            const formatMoney = (amount) => amount.toLocaleString('fr-TN', { style: 'currency', currency: 'TND', minimumFractionDigits: 3 });
            const formatNumber = (num) => num.toLocaleString('fr-TN', { maximumFractionDigits: 2 });

            // --- UI RENDER ---
            
            const liveMetrics = calculateMetrics();
            const siteLogs = logs.filter(l => l.siteId === currentSite).sort((a, b) => b.id - a.id);
            const lastLog = siteLogs.length > 0 ? siteLogs[0] : null;
            const isFormDirty = formData[currentSite].newIndex !== '' || formData[currentSite].cosPhi !== '';
            const displayMetrics = isFormDirty ? liveMetrics : (lastLog || liveMetrics);
            
            const displayContext = isFormDirty ? {
                title: "SIMULATION EN COURS",
                isLive: true,
                date: formData[currentSite].date,
                cosPhi: formData[currentSite].cosPhi,
                lateFees: formData[currentSite].lateFees,
                relanceFees: formData[currentSite].relanceFees,
                adjustment: formData[currentSite].adjustment,
                emptyLosses: siteConfigs[currentSite].emptyLosses
            } : {
                title: lastLog ? "DERNIÈRE FACTURE VALIDÉE" : "AUCUNE DONNÉE",
                isLive: false,
                date: lastLog ? lastLog.recordDate : formData[currentSite].date,
                cosPhi: lastLog ? lastLog.cosPhi : '',
                lateFees: lastLog ? lastLog.lateFees : '',
                relanceFees: lastLog ? lastLog.relanceFees : '',
                adjustment: lastLog ? lastLog.adjustment : '',
                emptyLosses: siteConfigs[currentSite].emptyLosses 
            };

            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 font-sans selection:bg-blue-200">
                
                {/* Header */}
                <header className="bg-gradient-to-r from-blue-900 to-slate-900 text-white shadow-lg sticky top-0 z-30">
                    <div className="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center">
                    <div className="flex items-center space-x-3 mb-2 md:mb-0">
                        <div className="p-2 bg-yellow-500 rounded-lg text-blue-900 shadow-lg shadow-yellow-500/20">
                        <Zap size={24} strokeWidth={2.5} />
                        </div>
                        <div>
                        <h1 className="text-xl font-bold tracking-tight">Gestion Facturation STEG</h1>
                        <div className="flex items-center space-x-2 text-xs text-blue-200">
                            <span className="bg-blue-800 px-1.5 py-0.5 rounded border border-blue-700">MT</span>
                            <span>Calculateur de Facture Normalisé</span>
                        </div>
                        </div>
                    </div>
                    
                    <div className="flex items-center gap-3">
                        <button 
                        onClick={() => setShowUserGuide(true)}
                        className="flex items-center bg-emerald-700 hover:bg-emerald-600 px-3 py-2 rounded-lg text-xs font-bold transition-colors border border-emerald-600"
                        >
                        <BookOpen size={16} className="mr-2 text-white" />
                        Guide Utilisation
                        </button>
                        <button 
                        onClick={() => setShowHelp(true)}
                        className="flex items-center bg-blue-800 hover:bg-blue-700 px-3 py-2 rounded-lg text-xs font-bold transition-colors border border-blue-700"
                        >
                        <HelpCircle size={16} className="mr-2 text-yellow-400" />
                        Guide Cos φ
                        </button>
                    </div>
                    </div>
                </header>

                {/* Modals */}
                {showUserGuide && (
                    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" onClick={() => setShowUserGuide(false)}>
                    <div className="bg-white rounded-2xl max-w-2xl w-full p-6 shadow-2xl relative" onClick={e => e.stopPropagation()}>
                        <button onClick={() => setShowUserGuide(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600">✕</button>
                        <h2 className="text-xl font-bold text-emerald-800 mb-4 flex items-center">
                        <BookOpen className="mr-2" />
                        Guide d'Utilisation
                        </h2>
                        <div className="space-y-4 text-sm text-slate-700 leading-relaxed bg-slate-50 p-4 rounded-xl border border-slate-200 h-[60vh] overflow-y-auto">
                           <p>Sélectionnez un site, entrez le nouvel index (1.8.0), le Cos φ et la puissance max atteinte.</p>
                           <p>Le calculateur gère automatiquement les bonifications et pénalités.</p>
                        </div>
                        <div className="mt-6 flex justify-end">
                        <button onClick={() => setShowUserGuide(false)} className="bg-emerald-700 hover:bg-emerald-800 text-white px-6 py-2 rounded-lg font-bold">Compris</button>
                        </div>
                    </div>
                    </div>
                )}

                {showHelp && (
                    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm" onClick={() => setShowHelp(false)}>
                    <div className="bg-white rounded-2xl max-w-2xl w-full p-6 shadow-2xl relative" onClick={e => e.stopPropagation()}>
                        <button onClick={() => setShowHelp(false)} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600">✕</button>
                        <h2 className="text-xl font-bold text-blue-900 mb-4 flex items-center"><FileText className="mr-2" /> Règle Cos φ</h2>
                        <div className="space-y-4 text-sm text-slate-700 leading-relaxed bg-slate-50 p-4 rounded-xl border border-slate-200 h-[60vh] overflow-y-auto">
                            <p>Bonification si Cos φ > 0.90.</p>
                            <p>Pénalité progressive si Cos φ < 0.80.</p>
                        </div>
                        <div className="mt-6 flex justify-end">
                        <button onClick={() => setShowHelp(false)} className="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold">Fermer</button>
                        </div>
                    </div>
                    </div>
                )}

                <main className="max-w-7xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
                    
                    {/* Colonne Gauche : Saisie */}
                    <div className="lg:col-span-7 space-y-6">
                    
                    <div className="grid grid-cols-3 gap-2">
                        {SITES.map((site) => (
                        <button
                            key={site.id}
                            onClick={() => setCurrentSite(site.id)}
                            className={`p-3 rounded-lg border text-sm font-bold transition-all
                            ${currentSite === site.id 
                                ? 'bg-blue-700 text-white border-blue-800 shadow-md' 
                                : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'
                            }`}
                        >
                            {site.name}
                        </button>
                        ))}
                    </div>

                    <form onSubmit={handleSubmit} className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 space-y-6">
                        
                        <div className="flex justify-between items-center border-b border-slate-100 pb-4">
                        <h2 className="text-lg font-bold text-slate-800 flex items-center">
                            <Calendar className="mr-2 text-blue-600" size={20} />
                            Saisie Relevé
                        </h2>
                        <input 
                            type="month"
                            value={formData[currentSite].date || ''}
                            onChange={(e) => handleInputChange('date', e.target.value)}
                            className="bg-slate-100 border-none rounded px-3 py-1 font-bold text-slate-700 cursor-pointer focus:ring-2 focus:ring-blue-500"
                        />
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <div className="space-y-4">
                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider">Compteur Actif</h3>
                            <div className="bg-slate-50 p-4 rounded-lg border border-slate-200 space-y-3">
                                <div>
                                <label className="text-xs font-bold text-slate-500 block mb-1">Ancien Index</label>
                                <input 
                                    type="text" 
                                    inputMode="numeric"
                                    value={formatInputDisplay(formData[currentSite].lastIndex || '')}
                                    onChange={(e) => handleInputChange('lastIndex', e.target.value)}
                                    className={`w-full text-sm p-2 border rounded font-mono ${formData[currentSite].manualLastIndex ? 'bg-orange-50 border-orange-300' : 'bg-slate-200 border-slate-300'}`}
                                />
                                </div>
                                <div>
                                <label className="text-xs font-bold text-blue-700 block mb-1">Nouvel Index *</label>
                                <input 
                                    type="text"
                                    inputMode="numeric"
                                    required
                                    placeholder="000 000"
                                    value={formatInputDisplay(formData[currentSite].newIndex || '')}
                                    onChange={(e) => handleInputChange('newIndex', e.target.value)}
                                    className="w-full text-lg p-2 border-2 border-blue-200 rounded focus:border-blue-600 focus:outline-none font-mono tracking-wide"
                                />
                                </div>
                            </div>
                        </div>

                        <div className="space-y-4">
                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider">Technique</h3>
                            <div className="bg-slate-50 p-4 rounded-lg border border-slate-200 space-y-3">
                                <div>
                                <label className="text-xs font-bold text-slate-500 block mb-1">Cos φ *</label>
                                <input 
                                    type="number" step="0.01" min="0" max="1" required placeholder="0.92"
                                    value={formData[currentSite].cosPhi || ''}
                                    onChange={(e) => handleInputChange('cosPhi', e.target.value)}
                                    className="w-full text-sm p-2 border border-slate-300 rounded focus:border-blue-500 focus:outline-none"
                                />
                                </div>
                                <div>
                                <label className="text-xs font-bold text-slate-500 block mb-1">P. Max (kVA) *</label>
                                <div className="relative">
                                    <input 
                                    type="number" required placeholder="kVA"
                                    value={formData[currentSite].maxPower || ''}
                                    onChange={(e) => handleInputChange('maxPower', e.target.value)}
                                    className={`w-full text-sm p-2 border rounded focus:outline-none ${liveMetrics.isPowerOverrun ? 'border-red-400 bg-red-50 text-red-700' : 'border-slate-300'}`}
                                    />
                                    {liveMetrics.isPowerOverrun && <AlertCircle size={14} className="absolute right-2 top-2.5 text-red-500" />}
                                </div>
                                </div>
                            </div>
                        </div>

                        </div>

                        {/* Cas Particuliers */}
                        <div className="border-t border-slate-100 pt-4">
                        <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Frais & Ajustements</h3>
                        <div className="grid grid-cols-3 gap-4">
                            <input type="number" placeholder="Retard (DT)" value={formData[currentSite].lateFees || ''} onChange={(e) => handleInputChange('lateFees', e.target.value)} className="w-full text-sm p-2 border border-slate-200 rounded" />
                            <input type="number" placeholder="Relance (DT)" value={formData[currentSite].relanceFees || ''} onChange={(e) => handleInputChange('relanceFees', e.target.value)} className="w-full text-sm p-2 border border-slate-200 rounded" />
                            <input type="number" placeholder="Ajust. (DT)" value={formData[currentSite].adjustment || ''} onChange={(e) => handleInputChange('adjustment', e.target.value)} className="w-full text-sm p-2 border border-slate-200 rounded" />
                        </div>
                        </div>

                        <button type="submit" className="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-700/20 transition-transform active:scale-95 flex items-center justify-center">
                        <Save size={20} className="mr-2" />
                        Valider
                        </button>
                    </form>

                    {/* Configuration Zone */}
                    <div className="bg-slate-100 rounded-xl border border-slate-200 overflow-hidden">
                        <button onClick={() => setIsConfigUnlocked(!isConfigUnlocked)} className="w-full px-6 py-3 flex justify-between items-center text-xs font-bold text-slate-500 uppercase hover:bg-slate-200">
                        <span><Settings size={14} className="inline mr-2" /> Configuration & Tarifs</span>
                        {isConfigUnlocked ? <Unlock size={14} className="text-red-500" /> : <Lock size={14} />}
                        </button>
                        
                        {isConfigUnlocked && (
                        <div className="p-6 bg-white border-t border-slate-200 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="space-y-2">
                                <h4 className="text-xs font-bold text-blue-700">Paramètres Site</h4>
                                <input type="number" value={siteConfigs[currentSite].subscribedPower || ''} onChange={(e) => handleSiteConfigChange('subscribedPower', e.target.value)} className="w-full border p-1 rounded text-sm" placeholder="P. Souscrite" />
                                <input type="number" value={siteConfigs[currentSite].emptyLosses || ''} onChange={(e) => handleSiteConfigChange('emptyLosses', e.target.value)} className="w-full border p-1 rounded text-sm" placeholder="Pertes à vide" />
                            </div>
                            <div className="space-y-2">
                                <h4 className="text-xs font-bold text-blue-700">Paramètres Globaux</h4>
                                <div className="grid grid-cols-2 gap-2">
                                    <input type="number" step="0.001" value={globalConfig.unitPriceKwh || ''} onChange={(e) => handleGlobalConfigChange('unitPriceKwh', e.target.value)} className="w-full border p-1 rounded text-sm" />
                                    <input type="number" step="0.001" value={globalConfig.powerUnitPrice || ''} onChange={(e) => handleGlobalConfigChange('powerUnitPrice', e.target.value)} className="w-full border p-1 rounded text-sm" />
                                </div>
                            </div>
                        </div>
                        )}
                    </div>
                    </div>

                    {/* Colonne Droite : Ticket */}
                    <div className="lg:col-span-5 space-y-4">
                    
                    <div className={`bg-white p-6 rounded-xl shadow-lg border transition-all duration-300 relative overflow-hidden
                        ${displayContext.isLive ? 'border-blue-200' : 'border-emerald-200 ring-2 ring-emerald-50'}`}>
                        
                        <div className="absolute top-0 right-0 p-4 opacity-5 pointer-events-none"><Zap size={100} /></div>

                        <div className="flex justify-between items-end border-b-2 border-slate-100 pb-4 mb-4">
                        <div>
                            <h3 className={`text-sm font-bold uppercase ${displayContext.isLive ? 'text-blue-600' : 'text-emerald-700'}`}>{displayContext.title}</h3>
                            <p className="text-xs text-slate-400">{SITES.find(s=>s.id===currentSite).name}</p>
                        </div>
                        <div className="text-right">
                            <p className="text-xs text-slate-400">Date Relevé</p>
                            <p className="font-mono font-bold text-slate-700">{displayContext.date}</p>
                        </div>
                        </div>

                        <div className="space-y-3 text-sm">
                        
                        <div className="pb-3 border-b border-slate-50 border-dashed">
                            <div className="flex justify-between text-slate-600">
                            <span>Énergie ({formatInputDisplay(displayMetrics.energyRecorded)} kWh + Pertes)</span>
                            <span className="font-mono">{formatMoney(displayMetrics.baseEnergyAmountHT)}</span>
                            </div>
                        </div>

                        <div className="pb-3 border-b border-slate-50 border-dashed">
                            <div className="flex justify-between items-center">
                                <span className="text-slate-600">Ajustement Cos φ ({displayContext.cosPhi || '-'})</span>
                                {displayMetrics.adjustmentType === 'bonus' && <span className="text-[10px] bg-emerald-100 text-emerald-800 px-1 rounded">BONUS</span>}
                                {displayMetrics.adjustmentType === 'penalty' && <span className="text-[10px] bg-red-100 text-red-800 px-1 rounded">PENALITÉ</span>}
                            </div>
                            <div className={`flex justify-between font-mono font-bold mt-1 ${displayMetrics.adjustmentRate < 0 ? 'text-emerald-600' : (displayMetrics.adjustmentRate > 0 ? 'text-red-600' : 'text-slate-400')}`}>
                            <span>{displayMetrics.adjustmentRate > 0 ? '+' : ''}{(displayMetrics.adjustmentRate * 100).toFixed(1)}%</span>
                            <span>{displayMetrics.adjustmentRate > 0 ? '+' : ''}{formatMoney(displayMetrics.cosPhiAdjustmentAmount)}</span>
                            </div>
                        </div>

                        <div className="flex justify-between font-bold text-slate-800 bg-blue-50 p-2 rounded">
                            <span>Total 1 (Énergie TTC)</span>
                            <span>{formatMoney(displayMetrics.total1_TTC)}</span>
                        </div>

                        <div className="pt-2 space-y-1">
                            <div className="flex justify-between text-slate-600 text-xs">
                                <span>Prime Fixe + Frais</span>
                                <span className="font-mono">{formatMoney(displayMetrics.total2_TTC)}</span>
                            </div>
                        </div>

                        <div className="space-y-1 pt-2 text-xs text-slate-500">
                            <div className="flex justify-between"><span>Taxes & RTT</span><span className="font-mono">{formatMoney(displayMetrics.municipalTax + globalConfig.rtt)}</span></div>
                        </div>

                        </div>

                        <div className="mt-6 border-t-2 border-slate-800 pt-4">
                        <div className="flex justify-between items-end">
                            <span className="text-lg font-black text-slate-900 uppercase">Net à Payer</span>
                            <span className={`text-3xl font-black font-mono tracking-tight ${displayContext.isLive ? 'text-blue-700' : 'text-emerald-700'}`}>
                            {formatMoney(displayMetrics.netToPay)}
                            </span>
                        </div>
                        </div>
                    </div>

                    {/* Historique Rapide */}
                    <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col h-[200px]">
                        <h3 className="text-xs font-bold text-slate-400 uppercase mb-3"><History size={12} className="inline mr-1" /> Historique Récent</h3>
                        <div className="flex-1 overflow-y-auto space-y-2 pr-1">
                        {siteLogs.map(log => (
                            <div key={log.id} className="p-2 bg-slate-50 rounded border border-slate-100 flex justify-between items-center text-xs">
                                <span>{log.recordDate}</span>
                                <span className="font-bold text-blue-700">{formatMoney(log.netToPay)}</span>
                            </div>
                        ))}
                        </div>
                    </div>

                    </div>
                </main>

                {notification && (
                    <div className={`fixed bottom-6 right-6 px-6 py-4 rounded-xl shadow-2xl text-white font-medium flex items-center animate-bounce-short z-50
                    ${notification.type === 'error' ? 'bg-red-500' : 'bg-emerald-600'}`}>
                    {notification.type === 'error' ? <AlertTriangle className="mr-2" /> : <CheckCircle2 className="mr-2" />}
                    {notification.msg}
                    </div>
                )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
